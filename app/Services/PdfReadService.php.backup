<?php

namespace App\Services;

use Illuminate\Support\Facades\Log;
use Spatie\PdfToText\Pdf;
use Livewire\Features\SupportFileUploads\TemporaryUploadedFile;
use setasign\Fpdi\Fpdi;

use function Laravel\Prompts\text;

class PdfReadService
{
    /**
     * Read text from a PDF file using Spatie's PdfToText package.
     *
     * @param  string  $pdfPath  Path to the PDF file.
     * @return string Extracted text from the PDF.
     */
    public function getPdfTextwithSpatie($file)
    {
        $pdftoTextPath = config('services.pdftotext.path');

        if (empty($pdftoTextPath)) {
            throw new \RuntimeException('PDFTOTEXT_PATH is not configured. Please set it in .env file.');
        }

        $text = Pdf::getText($file->getRealPath(), $pdftoTextPath);

        return $text;
    }

    public function extractPdf($text)
    {
        // Normalisasi: ubah NBSP jadi space, normalisasi newline, pastikan UTF-8
        $text = mb_convert_encoding($text, 'UTF-8', 'auto');
        $text = preg_replace('/\x{00A0}/u', ' ', $text); // NBSP -> space
        $text = str_replace(["\r\n", "\r"], "\n", $text); // unify newlines

        $data = [];

        // ðŸ”¹ FAIL FAST: No.SEP - Field WAJIB
        if (! preg_match('/No\.SEP\s*(?:\s*):\s*([\w\/\.-]+)/i', $text, $m)) {
            throw new \RuntimeException('No. SEP tidak ditemukan di file. Pastikan file SEP yang valid.');
        }
        
        $data['sep_number'] = trim($m[1]);

        // ðŸ”¹ FAIL FAST: Tgl.SEP - Field WAJIB
        if (! preg_match('/Tgl\.SEP\s*(?:\s*):\s*([0-9]{4}-[0-9]{2}-[0-9]{2})/i', $text, $m)) {
            throw new \RuntimeException('Tanggal SEP tidak ditemukan atau format salah. Harus YYYY-MM-DD.');
        }
        $data['sep_date'] = trim($m[1]);

        // ðŸ”¹ FAIL FAST: No.Kartu & MR - Field WAJIB
        if (! preg_match('/No\.Kartu[^\:]*:\s*([0-9]+)\s*\(\s*MR\.?\s*([0-9]+)\s*\)/i', $text, $m)) {
            throw new \RuntimeException('No. Kartu BPJS atau No. RM tidak ditemukan. Format: No.Kartu : 0001234567890 (MR. 123456)');
        }
        $data['bpjs_number'] = trim($m[1]);
        $data['medical_record_number'] = trim($m[2]);

        // ðŸ”¹ FAIL FAST: Nama Peserta - Field WAJIB
        $namaFound = false;
        if (preg_match('/Nama\s*Peserta\s*(?:\s*):\s*([^\n\r]+)/i', $text, $m)) {
            $nama = trim($m[1]);
            // Bersihkan jika ada format "No.Kartu : xxx (MR. xxx) : Nama"
            if (preg_match('/.*\)\s*:\s*(.+)$/i', $nama, $cleanMatch)) {
                $data['patient_name'] = trim($cleanMatch[1]);
                $namaFound = true;
            } elseif (! empty($nama)) {
                $data['patient_name'] = $nama;
                $namaFound = true;
            }
        }

        // Alternatif: cari setelah (MR. xxx) : Nama
        if (! $namaFound && preg_match('/\(MR\.?\s*[0-9]+\)\s*:\s*([^\n\r]+)/i', $text, $m)) {
            $data['patient_name'] = trim($m[1]);
            $namaFound = true;
        }

        if (! $namaFound || empty($data['patient_name'])) {
            throw new \RuntimeException('Nama Peserta tidak ditemukan di file SEP.');
        }

        // ðŸ”¹ FAIL FAST: Kelas Rawat - Field WAJIB
        if (! preg_match('/\bKelas\s+[0-9A-Za-z]+\b/i', $text, $m)) {
            throw new \RuntimeException('Kelas Rawat tidak ditemukan. Harus ada "Kelas 1", "Kelas 2", atau "Kelas 3".');
        }
        $data['patient_class'] = trim($m[0]);

        // ðŸ”¹ FAIL FAST: Jenis Rawat - Field WAJIB
        $jenisFound = false;
        if (preg_match('/Jns\.?\s*Rawat\s*[:\-]?\s*([R\. ]?(Jalan|Inap))/i', $text, $m)) {
            $rawat = strtoupper(trim($m[1]));

            if (strpos($rawat, 'INAP') !== false) {
                $data['jenis_rawatan'] = 'RI';
                $jenisFound = true;
            } elseif (strpos($rawat, 'JALAN') !== false) {
                $data['jenis_rawatan'] = 'RJ';
                $jenisFound = true;
            }
        }

        // Fallback: cari "R.Jalan" / "R.Inap" di teks
        if (! $jenisFound) {
            if (preg_match('/R\.?\s*JALAN/i', $text)) {
                $data['jenis_rawatan'] = 'RJ';
                $jenisFound = true;
            } elseif (preg_match('/R\.?\s*INAP/i', $text)) {
                $data['jenis_rawatan'] = 'RI';
                $jenisFound = true;
            }
        }

        if (! $jenisFound) {
            throw new \RuntimeException('Jenis Rawat tidak ditemukan. Harus ada "R.Jalan" atau "R.Inap".');
        }

        Log::info('SEP berhasil diekstrak', $data);

        return $data;
    }
    
    

    public function extractPdfAssist(string $text): array
    {
        Log::info('Starting PDF extraction with extractPdfAssist');

       
        try {
            // Step 1: Normalize text encoding and whitespace
            $text = $this->normalizeText($text);

            // Step 2: Normalize label variations
            $text = $this->normalizeLabels($text);

            // Step 3: Parse loose value rows (multi-column parsing disabled for new format)
            $text = $this->normalizeLooseValueRow($text);

            // Step 4: Extract fields
            $raw = $this->parseFields($text);

            // Step 5: Apply domain rules
            $data = $this->applyDomainRules($raw);

            Log::info('PDF extraction successful', [
                'sep_number' => $data['sep_number'] ?? 'N/A',
                'patient_name' => $data['patient_name'] ?? 'N/A'
            ]);

            return $data;

        } catch (\Throwable $e) {
            Log::error('PDF extraction failed', [
                'error' => $e->getMessage(),
            ]);
            throw $e;
        }
    }

    private function normalizeText(string $text): string
    {
    
        $text = mb_convert_encoding($text, 'UTF-8', 'auto');
        $text = preg_replace('/\x{00A0}/u', ' ', $text);
        $text = str_replace(["\r\n", "\r"], "\n", $text);
        $text = preg_replace('/[ \t]+/', ' ', $text);

        return trim($text);
    }

    private function normalizeLabels(string $text): string
    {
        $labels = [
            '/\bNo\.?\s*SEP\b/i'        => 'No.SEP',
            '/\bTgl\.?\s*SEP\b/i'       => 'Tgl.SEP',
            '/\bNo\.?\s*Kartu\b/i'      => 'No.Kartu',
            '/\bNama\s*Peserta\b/i'     => 'Nama Peserta',
            '/\bJns\.?\s*Rawat\b/i'     => 'Jns.Rawat',
            // '/\bKls\.?\s*Rawat\b/i'     => 'Kls.Rawat',
        ];

        foreach ($labels as $pattern => $canonical) {
            $text = preg_replace($pattern, $canonical, $text);
        }
       

        return $text;
    }

    private function extractMultiColumnHeader(string $text): array
    {
        $extracted = [];

    // Extract MR from No.Kartu line (format: No.Kartu : 0002138667153 ( 238136 ))
    $mrPattern = '/No\.Kartu\s*:\s*[0-9]+\s*\(\s*([0-9]+)\s*\)/i';
    if (preg_match($mrPattern, $text, $mrMatch)) {
        $extracted['medical_record_number'] = trim($mrMatch[1]);
    }

    // Extract sep_date (format: Tgl.SEP : 2026-01-19)
    if (preg_match('/Tgl\.SEP\s*:\s*([0-9\-]+)/i', $text, $m)) {
        $extracted['sep_date'] = trim($m[1]);
    }

    // Extract bpjs_number (format: No.Kartu : 0002138667153)
    if (preg_match('/No\.Kartu\s*:\s*([0-9]+)/i', $text, $m)) {
        $extracted['bpjs_number'] = trim($m[1]);
    }

    // Extract patient_name (format: Nama Peserta : PARSAULIAN SILALAHI)
    if (preg_match('/Nama\s*Peserta\s*:\s*([^\n]+)/i', $text, $m)) {
        $extracted['patient_name'] = trim($m[1]);
    }

    return $extracted;
}

private function parseFields(string $text): array
{
    $data = [];

    // Extract multi-column fields first to preserve medical_record_number
    $headerData = $this->extractMultiColumnHeader($text);
    $data = array_merge($data, $headerData);

    // Extract simple single-line fields
    $data['sep_number'] = $this->extractField('No.SEP', '/No\.SEP\s*:\s*([A-Z0-9\/\.]+)/i', $text);

    // Extract treatment type (normalized by normalizeLooseValueRow)
    $data['rawat_text'] = $this->extractField('Jns.Rawat', '/Jns\.Rawat\s*:\s*(R\.Jalan|R\.Inap)/i', $text);

    // Extract class from normalized text
    // $data['Kls.Rawat'] = $this->extractField('Kls.Rawat', '/Kls\.Rawat\s*:\s*([^\n]+)/i', $text);

    return $data;
}

private function extractField(string $label, string $pattern, string $text): string
{
    if (preg_match($pattern, $text, $m)) {
        return trim($m[1]);
    }

    throw new \RuntimeException("Field {$label} tidak ditemukan.");
}

    private function applyDomainRules(array $data): array
    {
        // Map treatment type: R.Jalan -> RJ, R.Inap -> RI
        if (isset($data['rawat_text'])) {
            $data['jenis_rawatan'] = match (strtoupper($data['rawat_text'])) {
                'R.JALAN' => 'RJ',
                'R.INAP'  => 'RI',
                default   => throw new \RuntimeException('Jenis Rawat tidak valid: ' . $data['rawat_text'])
            };
            unset($data['rawat_text']);
        }

        // Normalize patient class from "KELAS 1" to "1"
        if (isset($data['Kls.Rawat'])) {
            $data['patient_class'] = $this->normalizeClass($data['Kls.Rawat']);
            unset($data['Kls.Rawat']);
        }

        // Validate date
        if (isset($data['sep_date']) && !strtotime($data['sep_date'])) {
            throw new \RuntimeException('Tanggal SEP tidak valid: ' . $data['sep_date']);
        }

        return $data;
    }

    private function normalizeClass(string $classText): string
    {
       
        if (preg_match('/(\d+)/', $classText, $m)) {
            return $m[1];
        }
        throw new \RuntimeException('Kelas rawat tidak valid: ' . $classText);
    }

    private function normalizeLooseValueRow(string $text): string
    {
        // Match: Jns.Rawat Jns.Kunjungan Kls.Hak Kls.Rawat Penjamin
        // With values like: : R.Jalan :: KELAS 1 ::
        $pattern = '/Jns\.Rawat\s+Jns\.Kunjungan\s+Kls\.Hak\s+Kls\.Rawat\s+Penjamin\s*\n\s*:\s*(R\.(?:Jalan|Inap))\s*::\s*(KELAS\s*[1-3])\s*::/i';

        if (preg_match($pattern, $text, $m)) {
            // Append structured fields to text
            $text .= "\nJns.Rawat : " . trim($m[1]);
            $text .= "\nKls.Rawat : " . trim($m[2]);
        }

        return $text;
    }

    /**
     * Extract Jenis Rawatan by format (R.Jalan or R.Inap anywhere in text)
     * Returns: 'RJ' or 'RI'
     */
    private function extractJenisRawatanByFormat(string $text): string
    {
        // Search for R.Jalan or R.Inap regardless of line breaks
        if (preg_match('/\bR\.(?:Jalan|Inap)\b/i', $text, $m)) {
            return strtoupper($m[0]) === 'R.JALAN' ? 'RJ' : 'RI';
        }

        throw new \RuntimeException('Jenis Rawatan (R.Jalan/R.Inap) tidak ditemukan.');
    }

    /**
     * Extract Kelas Rawatan by format (KELAS 1/2/3 anywhere in text)
     * Returns: '1', '2', or '3'
     */
    private function extractKelasRawatanByFormat(string $text): string
    {
        // Search for KELAS 1, KELAS 2, or KELAS 3
        if (preg_match('/\bKELAS\s*([1-3])\b/i', $text, $m)) {
            return $m[1];
        }

        throw new \RuntimeException('Kelas Rawatan (KELAS 1/2/3) tidak ditemukan.');
    }

    /**
     * Extract BPJS number (13 digits) near "No.Kartu" label
     * Uses proximity to avoid false positives with other 13-digit numbers
     */
    private function extractBpjsNumberNearLabel(string $text, int $distance = 100): string
    {
        // Find "No.Kartu" position
        if (preg_match('/No\.Kartu/i', $text, $labelMatch, PREG_OFFSET_CAPTURE)) {
            $labelPos = $labelMatch[0][1];

            // Search for 13 digits within distance characters after label
            $searchText = substr($text, $labelPos, $distance + 50);
            if (preg_match('/\b(\d{13})\b/', $searchText, $m)) {
                return $m[1];
            }
        }

        throw new \RuntimeException('No. Kartu BPJS (13 digit) tidak ditemukan dekat label No.Kartu.');
    }

    /**
     * Extract MR Number (6 digits in parentheses format)
     * Example: "( 238136 )"
     */
    private function extractMrNumberByFormat(string $text): string
    {
        // Search for 6 digits inside parentheses
        if (preg_match('/\(\s*(\d{6})\s*\)/', $text, $m)) {
            return $m[1];
        }

        throw new \RuntimeException('No. RM (6 digit dalam kurung) tidak ditemukan.');
    }




    /**
     * Ensure the uploaded PDF only contains a single page.
     *
     * @throws \RuntimeException when PDF has more than one page or cannot be parsed
     */
    public function ensureSinglePage(TemporaryUploadedFile $file): void
    {
        $fpdi = new Fpdi();
        $pageCount = $fpdi->setSourceFile($file->getRealPath());

        if ($pageCount !== 1) {
            throw new \RuntimeException('File SEP harus hanya 1 halaman');
        }
    }
}
